<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ô‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - Real-time</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, remove, serverTimestamp, off } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        // Firebase config ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö demo (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á)
        const firebaseConfig = {
            apiKey: "AIzaSyDummy-Key-For-Demo-Usage-Only",
            authDomain: "inventory-realtime-demo.firebaseapp.com",
            databaseURL: "https://inventory-realtime-demo-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "inventory-realtime-demo",
            storageBucket: "inventory-realtime-demo.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456ghi789"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ accessible ‡∏à‡∏≤‡∏Å global scope
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseRemove = remove;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebaseOff = off;
        
        console.log("Firebase initialized successfully");
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .online-indicator {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            margin-top: 15px;
            display: inline-block;
        }
        
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online { background: #00ff00; }
        .status-dot.connecting { background: #ffff00; }
        .status-dot.offline { background: #ff0000; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .content {
            padding: 30px;
        }
        
        .setup-section {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .setup-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .input-section {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .input-section h3 {
            color: #155724;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #1e7e34;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .input-group {
            margin: 20px 0;
            padding: 20px;
            background: #f1f3f4;
            border-radius: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .inventory-list {
            margin-top: 30px;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin: 10px 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .inventory-item.new-item {
            background: linear-gradient(90deg, #d4edda, #ffffff);
            border-color: #28a745;
            animation: slideIn 0.5s ease;
        }
        
        .inventory-item.updated-item {
            background: linear-gradient(90deg, #fff3cd, #ffffff);
            border-color: #ffc107;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .inventory-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .item-info {
            flex-grow: 1;
        }
        
        .item-code {
            font-family: monospace;
            color: #666;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .item-quantity {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            margin: 0 20px;
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 10px;
        }
        
        .item-datetime {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
        
        .item-device {
            font-size: 0.7em;
            color: #888;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            margin-top: 3px;
        }
        
        .realtime-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .status {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .online-users {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .online-users h4 {
            color: #155724;
            margin-bottom: 15px;
        }
        
        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .user-badge {
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #28a745;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-badge .status-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
        }
        
        .export-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .inventory-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .item-quantity {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ô‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
            <p>Real-time Sync - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            <div class="online-indicator">
                <span class="status-dot connecting" id="connectionDot"></span>
                <span id="connectionStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            </div>
        </div>
        
        <div class="content">
            <!-- Setup Section -->
            <div class="setup-section">
                <h3>üöÄ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                
                <div class="input-group" style="background: white;">
                    <label for="storeId">‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á):</label>
                    <input type="text" id="storeId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô shop001" value="">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        üí° ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                    </small>
                </div>
                
                <div class="input-group" style="background: white;">
                    <label for="deviceName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ:</label>
                    <input type="text" id="deviceName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠-‡πÅ‡∏à‡πâ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≠‡∏°-‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" value="">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        üí° ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
                    </small>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="connectToStore()" id="connectBtn">
                        üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            </div>
            
            <!-- Online Users Section -->
            <div class="online-users" id="onlineUsersSection" style="display: none;">
                <h4>üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h4>
                <div class="user-list" id="userList">
                    <div class="user-badge">
                        <span class="status-dot"></span>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                    </div>
                </div>
            </div>
            
            <!-- Input Section -->
            <div class="input-section" id="inputSection" style="display: none;">
                <h3>‚ö° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!</h3>
                
                <div class="input-group">
                    <label for="productCode">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
                    <input type="text" id="productCode" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô 8850188210300" autofocus>
                </div>
                
                <div class="input-group">
                    <label for="productName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
                    <input type="text" id="productName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group" style="margin: 10px 0;">
                        <label for="quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                        <input type="number" id="quantity" min="1" value="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
                    </div>
                    
                    <div class="input-group" style="margin: 10px 0;">
                        <label for="action">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥:</label>
                        <select id="action">
                            <option value="add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</option>
                            <option value="set">‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà</option>
                            <option value="subtract">‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="addItem()" id="addBtn" style="font-size: 20px; padding: 20px 50px;">
                        üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    </button>
                    <button class="btn btn-primary" onclick="clearForm()" style="font-size: 18px; padding: 18px 40px;">
                        üîÑ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                    </button>
                </div>
            </div>
            
            <!-- Status Messages -->
            <div id="statusMessage"></div>
            
            <!-- Statistics -->
            <div class="stats" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalItems">0</div>
                    <div>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalQuantity">0</div>
                    <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="onlineCount">0</div>
                    <div>‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
                </div>
            </div>
            
            <!-- Inventory List -->
            <div class="inventory-list" id="inventorySection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - Real-time</h3>
                    <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
                <div id="inventoryItems">
                    <p style="text-align: center; color: #999; padding: 40px; font-size: 18px;">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...<br>
                        <small>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö Real-time ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</small>
                    </p>
                </div>
            </div>
            
            <!-- Export Section -->
            <div class="export-section" id="exportSection" style="display: none;">
                <h3>üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <button class="btn btn-primary" onclick="exportData()">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
                <button class="btn btn-primary" onclick="printData()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        let inventory = {};
        let currentStoreId = '';
        let currentDeviceName = '';
        let deviceId = generateDeviceId();
        let isConnected = false;
        let inventoryRef = null;
        let onlineUsersRef = null;
        let lastItemUpdate = {};
        let onlineUsers = {};

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Device ID
        function generateDeviceId() {
            let id = localStorage.getItem('deviceId');
            if (!id) {
                id = 'device_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 6);
                localStorage.setItem('deviceId', id);
            }
            return id;
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏û
        window.addEventListener('load', function() {
            setupKeyNavigation();
            loadSettings();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const checkFirebase = setInterval(() => {
                if (window.firebaseDB) {
                    clearInterval(checkFirebase);
                    updateConnectionStatus('connecting', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase');
                }
            }, 500);
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        function loadSettings() {
            const savedStoreId = localStorage.getItem('storeId');
            const savedDeviceName = localStorage.getItem('deviceName');
            
            if (savedStoreId) {
                document.getElementById('storeId').value = savedStoreId;
            }
            
            if (savedDeviceName) {
                document.getElementById('deviceName').value = savedDeviceName;
            } else {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                const userAgent = navigator.userAgent.toLowerCase();
                let defaultName = '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
                
                if (userAgent.includes('mobile')) {
                    defaultName = '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠-' + deviceId.slice(-4);
                } else if (userAgent.includes('tablet')) {
                    defaultName = '‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï-' + deviceId.slice(-4);
                } else {
                    defaultName = '‡∏Ñ‡∏≠‡∏°-' + deviceId.slice(-4);
                }
                
                document.getElementById('deviceName').value = defaultName;
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        function updateConnectionStatus(status, message) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionStatus');
            
            dot.className = `status-dot ${status}`;
            text.textContent = message;
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter
        function setupKeyNavigation() {
            const productCode = document.getElementById('productCode');
            const productName = document.getElementById('productName');
            const quantity = document.getElementById('quantity');

            if (productCode) {
                productCode.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        productName.focus();
                    }
                });
            }

            if (productName) {
                productName.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        quantity.focus();
                    }
                });
            }

            if (quantity) {
                quantity.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addItem();
                    }
                });
            }
        }

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
        async function connectToStore() {
            const storeId = document.getElementById('storeId').value.trim();
            const deviceName = document.getElementById('deviceName').value.trim();
            
            if (!storeId) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô', 'error');
                return;
            }
            
            if (!deviceName) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', 'error');
                return;
            }

            if (!window.firebaseDB) {
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö localStorage ‡πÅ‡∏ó‡∏ô Firebase
                showStatus('‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Local Storage (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)', 'info');
                connectWithLocalStorage(storeId, deviceName);
                return;
            }
            
            try {
                currentStoreId = storeId;
                currentDeviceName = deviceName;
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                localStorage.setItem('storeId', storeId);
                localStorage.setItem('deviceName', deviceName);
                
                updateConnectionStatus('connecting', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
                
                // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Firebase
                inventoryRef = window.firebaseRef(window.firebaseDB, `stores/${storeId}/inventory`);
                onlineUsersRef = window.firebaseRef(window.firebaseDB, `stores/${storeId}/onlineUsers/${deviceId}`);
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                await window.firebaseSet(onlineUsersRef, {
                    name: deviceName,
                    deviceId: deviceId,
                    lastSeen: window.firebaseServerTimestamp(),
                    userAgent: navigator.userAgent.substring(0, 50)
                });
                
                // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                window.firebaseOnValue(inventoryRef, (snapshot) => {
                    const data = snapshot.val();
                    inventory = data || {};
                    updateDisplay();
                });
                
                // ‡∏ü‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                const allUsersRef = window.firebaseRef(window.firebaseDB, `stores/${storeId}/onlineUsers`);
                window.firebaseOnValue(allUsersRef, (snapshot) => {
                    const users = snapshot.val() || {};
                    updateOnlineUsers(users);
                });
                
                // ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
                window.addEventListener('beforeunload', () => {
                    if (onlineUsersRef) {
                        window.firebaseRemove(onlineUsersRef);
                    }
                });
                
                isConnected = true;
                updateConnectionStatus('online', `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ${storeId} ‡πÅ‡∏•‡πâ‡∏ß`);
                showStatus(`üéâ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡πâ‡∏≤‡∏ô: ${storeId} | ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${deviceName}`, 'success');
                
                // ‡πÅ‡∏™‡∏î‡∏á UI
                showMainUI();
                
            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus('offline', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
                showStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + error.message + ' (‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Local)', 'error');
                
                // Fallback ‡πÑ‡∏õ localStorage
                connectWithLocalStorage(storeId, deviceName);
            }
        }

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ localStorage (‡∏™‡∏≥‡∏£‡∏≠‡∏á)
        function connectWithLocalStorage(storeId, deviceName) {
            currentStoreId = storeId;
            currentDeviceName = deviceName;
            
            localStorage.setItem('storeId', storeId);
            localStorage.setItem('deviceName', deviceName);
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏πŸÑ
            const stored = localStorage.getItem(`inventory_${storeId}`);
            if (stored) {
                try {
                    inventory = JSON.parse(stored);
                } catch (e) {
                    inventory = {};
                }
            }
            
            isConnected = true;
            updateConnectionStatus('offline', 'Local Mode');
            showStatus(`üì± ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Local: ‡∏£‡πâ‡∏≤‡∏ô ${storeId} | ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${deviceName}`, 'info');
            
            showMainUI();
            updateDisplay();
        }

        // ‡πÅ‡∏™‡∏î‡∏á UI ‡∏´‡∏•‡∏±‡∏Å
        function showMainUI() {
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('inventorySection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            
            if (isConnected && window.firebaseDB) {
                document.getElementById('onlineUsersSection').style.display = 'block';
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
        function updateOnlineUsers(users) {
            onlineUsers = users;
            const userList = document.getElementById('userList');
            
            if (!users || Object.keys(users).length === 0) {
                userList.innerHTML = '<div class="user-badge">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>';
                document.getElementById('onlineCount').textContent = '0';
                return;
            }

            let userHTML = '';
            let activeUsers = 0;
            
            for (const [userId, user] of Object.entries(users)) {
                if (user && user.name) {
                    userHTML += `
                        <div class="user-badge">
                            <span class="status-dot"></span>
                            ${user.name}
                            ${userId === deviceId ? '(‡∏Ñ‡∏∏‡∏ì)' : ''}
                        </div>
                    `;
                    activeUsers++;
                }
            }
            
            userList.innerHTML = userHTML;
            document.getElementById('onlineCount').textContent = activeUsers.toString();
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        async function addItem() {
            const productCode = document.getElementById('productCode').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const action = document.getElementById('action').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!productCode) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                document.getElementById('productCode').focus();
                return;
            }

            if (!productName) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                document.getElementById('productName').focus();
                return;
            }

            if (quantity <= 0) {
                showStatus('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
                document.getElementById('quantity').focus();
                return;
            }

            try {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà
                let newQuantity = 0;
                const currentItem = inventory[productCode];
                const currentQty = currentItem ? currentItem.quantity : 0;

                switch (action) {
                    case 'add':
                        newQuantity = currentQty + quantity;
                        break;
                    case 'set':
                        newQuantity = quantity;
                        break;
                    case 'subtract':
                        newQuantity = Math.max(0, currentQty - quantity);
                        break;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                const itemData = {
                    code: productCode,
                    name: productName,
                    quantity: newQuantity,
                    lastUpdated: new Date().toISOString(),
                    lastDevice: currentDeviceName,
                    deviceId: deviceId,
                    action: action,
                    previousQuantity: currentQty
                };

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (window.firebaseDB && inventoryRef) {
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Firebase
                    const itemRef = window.firebaseRef(window.firebaseDB, `stores/${currentStoreId}/inventory/${productCode}`);
                    await window.firebaseSet(itemRef, itemData);
                } else {
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ localStorage
                    inventory[productCode] = itemData;
                    localStorage.setItem(`inventory_${currentStoreId}`, JSON.stringify(inventory));
                    updateDisplay();
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                let actionText = '';
                switch (action) {
                    case 'add': actionText = `‡πÄ‡∏û‡∏¥‡πà‡∏° ${quantity} ‡∏´‡∏ô‡πà‡∏ß‡∏¢`; break;
                    case 'set': actionText = `‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô ${quantity} ‡∏´‡∏ô‡πà‡∏ß‡∏¢`; break;
                    case 'subtract': actionText = `‡∏•‡∏î ${quantity} ‡∏´‡∏ô‡πà‡∏ß‡∏¢`; break;
                }
                
                showStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${productName} (${actionText})`, 'success');

                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                clearForm();

            } catch (error) {
                console.error('Error adding item:', error);
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function updateDisplay() {
            const inventoryItems = document.getElementById('inventoryItems');
            const totalItems = document.getElementById('totalItems');
            const totalQuantity = document.getElementById('totalQuantity');

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            const items = Object.values(inventory);
            const itemCount = items.length;
            const totalQty = items.reduce((sum, item) => sum + (item.quantity || 0), 0);

            totalItems.textContent = itemCount.toString();
            totalQuantity.textContent = totalQty.toString();

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (itemCount === 0) {
                inventoryItems.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px; font-size: 18px;">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö<br>
                        <small>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</small>
                    </p>
                `;
                return;
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const sortedItems = items.sort((a, b) => 
                new Date(b.lastUpdated) - new Date(a.lastUpdated)
            );

            let html = '';
            sortedItems.forEach(item => {
                const updateTime = new Date(item.lastUpdated);
                const isNew = Date.now() - updateTime.getTime() < 5000; // ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                let quantityClass = 'item-quantity';
                if (item.quantity === 0) {
                    quantityClass += ' text-danger';
                } else if (item.quantity < 10) {
                    quantityClass += ' text-warning';
                }

                html += `
                    <div class="inventory-item ${isNew ? 'new-item' : ''}" data-code="${item.code}">
                        ${isNew ? '<span class="realtime-badge">LIVE</span>' : ''}
                        
                        <div class="item-info">
                            <div style="font-size: 1.2em; font-weight: bold; color: #333;">
                                ${item.name}
                            </div>
                            <div class="item-code">${item.code}</div>
                            <div class="item-datetime">
                                üìÖ ${updateTime.toLocaleDateString('th-TH')} 
                                üïí ${updateTime.toLocaleTimeString('th-TH')}
                            </div>
                            <div class="item-device">
                                üì± ${item.lastDevice} 
                                ${item.action ? `(${getActionText(item.action, item.previousQuantity || 0, item.quantity)})` : ''}
                            </div>
                        </div>

                        <div class="${quantityClass}">
                            ${item.quantity.toLocaleString()} ‡∏´‡∏ô‡πà‡∏ß‡∏¢
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn btn-primary" onclick="editItem('${item.code}')" style="padding: 8px 16px; font-size: 14px;">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-danger" onclick="deleteItem('${item.code}')" style="padding: 8px 16px; font-size: 14px;">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                `;
            });

            inventoryItems.innerHTML = html;

            // ‡∏•‡∏ö highlight ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                document.querySelectorAll('.new-item').forEach(el => {
                    el.classList.remove('new-item');
                });
            }, 3000);
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        function getActionText(action, previousQty, currentQty) {
            const diff = currentQty - previousQty;
            switch (action) {
                case 'add': return `+${Math.abs(diff)}`;
                case 'subtract': return `-${Math.abs(diff)}`;
                case 'set': return `‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà`;
                default: return '';
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        function editItem(productCode) {
            const item = inventory[productCode];
            if (!item) return;

            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('productCode').value = item.code;
            document.getElementById('productName').value = item.name;
            document.getElementById('quantity').value = '1';
            document.getElementById('action').value = 'set';

            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('inputSection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('quantity').focus();

            showStatus(`üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.name}`, 'info');
        }

        // ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        async function deleteItem(productCode) {
            const item = inventory[productCode];
            if (!item) return;

            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${item.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }

            try {
                if (window.firebaseDB && inventoryRef) {
                    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Firebase
                    const itemRef = window.firebaseRef(window.firebaseDB, `stores/${currentStoreId}/inventory/${productCode}`);
                    await window.firebaseRemove(itemRef);
                } else {
                    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å localStorage
                    delete inventory[productCode];
                    localStorage.setItem(`inventory_${currentStoreId}`, JSON.stringify(inventory));
                    updateDisplay();
                }

                showStatus(`üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${item.name}" ‡πÅ‡∏•‡πâ‡∏ß`, 'success');

            } catch (error) {
                console.error('Error deleting item:', error);
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + error.message, 'error');
            }
        }

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
        function clearForm() {
            document.getElementById('productCode').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('action').value = 'add';
            
            // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            document.getElementById('productCode').focus();
        }

        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function clearAll() {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!')) {
                return;
            }

            try {
                if (window.firebaseDB && inventoryRef) {
                    // ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firebase
                    await window.firebaseRemove(inventoryRef);
                } else {
                    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å localStorage
                    inventory = {};
                    localStorage.removeItem(`inventory_${currentStoreId}`);
                    updateDisplay();
                }

                showStatus('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');

            } catch (error) {
                console.error('Error clearing all:', error);
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + error.message, 'error');
            }
        }

        // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV
        function exportData() {
            const items = Object.values(inventory);
            
            if (items.length === 0) {
                showStatus('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'error');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV
            let csv = '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï,‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï\n';
            
            items.forEach(item => {
                const date = new Date(item.lastUpdated).toLocaleString('th-TH');
                csv += `"${item.code}","${item.name}","${item.quantity}","${date}","${item.lastDevice || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'}"\n`;
            });

            // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `inventory_${currentStoreId}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showStatus('üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        function printData() {
            const items = Object.values(inventory);
            
            if (items.length === 0) {
                showStatus('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå', 'error');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå
            const printWindow = window.open('', '_blank');
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ${currentStoreId}</title>
                    <style>
                        body { font-family: 'Sarabun', Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .info { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .summary { margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
                        <h2>‡∏£‡πâ‡∏≤‡∏ô: ${currentStoreId}</h2>
                    </div>
                    
                    <div class="info">
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå:</strong> ${new Date().toLocaleString('th-TH')}</p>
                        <p><strong>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏î‡∏¢:</strong> ${currentDeviceName}</p>
                        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong> ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏ß‡∏°:</strong> ${items.reduce((sum, item) => sum + item.quantity, 0).toLocaleString()} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            items.sort((a, b) => a.name.localeCompare(b.name, 'th')).forEach((item, index) => {
                const date = new Date(item.lastUpdated).toLocaleString('th-TH');
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.code}</td>
                        <td>${item.name}</td>
                        <td style="text-align: right;">${item.quantity.toLocaleString()}</td>
                        <td>${date}</td>
                        <td>${item.lastDevice || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <h3>‡∏™‡∏£‡∏∏‡∏õ</h3>
                        <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${items.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${items.reduce((sum, item) => sum + item.quantity, 0).toLocaleString()}</strong> ‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                        <p>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å: <strong>${items.filter(item => item.quantity === 0).length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <p>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢ (< 10): <strong>${items.filter(item => item.quantity < 10 && item.quantity > 0).length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        <button onclick="window.close()" style="padding: 10px 20px; font-size: 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">‚ùå ‡∏õ‡∏¥‡∏î</button>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();

            showStatus('üñ®Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(async () => {
            if (onlineUsersRef && window.firebaseDB) {
                try {
                    await window.firebaseSet(onlineUsersRef, {
                        name: currentDeviceName,
                        deviceId: deviceId,
                        lastSeen: window.firebaseServerTimestamp(),
                        userAgent: navigator.userAgent.substring(0, 50)
                    });
                } catch (error) {
                    console.log('Failed to update online status:', error);
                }
            }
        }, 30000);

    </script>
</body>
</html>
